<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AgroAI | Live Roboflow Sync</title>
    <style>
        :root { --primary: #00ff88; --bg: #0b0f14; --glass: rgba(22, 27, 34, 0.9); }
        body { margin: 0; font-family: 'Segoe UI', system-ui, sans-serif; background: var(--bg); color: white; overflow: hidden; }
        .viewport { position: relative; width: 100vw; height: 100vh; background: #000; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .hud { position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%); width: 90%; max-width: 420px; z-index: 10; }
        .glass-panel { background: var(--glass); backdrop-filter: blur(25px); padding: 25px; border-radius: 35px; border: 1px solid rgba(255, 255, 255, 0.1); box-shadow: 0 20px 50px rgba(0,0,0,0.8); text-align: center; }
        .status-dot { display: inline-block; width: 8px; height: 8px; background: var(--primary); border-radius: 50%; margin-right: 8px; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.3; } }
        #soil-output { font-size: 2.2rem; font-weight: 900; margin: 10px 0; text-transform: uppercase; color: var(--primary); }
        .crop-container { display: flex; flex-wrap: wrap; justify-content: center; gap: 8px; margin-top: 15px; }
        .crop-badge { background: rgba(0, 255, 136, 0.1); border: 1px solid var(--primary); color: var(--primary); padding: 6px 14px; border-radius: 12px; font-size: 0.85rem; font-weight: 700; }
        canvas { display: none; }
    </style>
</head>
<body>

<div class="viewport">
    <video id="camera" autoplay playsinline></video>
    <div class="hud">
        <div class="glass-panel">
            <div style="font-size: 0.7rem; letter-spacing: 2px; color: #8b949e;">
                <span class="status-dot"></span>LIVE AI ANALYSIS
            </div>
            <h1 id="soil-output">Detecting...</h1>
            <div id="crop-output" class="crop-container"></div>
        </div>
    </div>
</div>

<canvas id="snapshot" width="416" height="416"></canvas>

<script>
    const API_KEY = "CxxhkxfjWLeZydDtSjFd";
    const WORKFLOW_URL = "https://serverless.roboflow.com/amithesh-yppof/workflows/custom-workflow";
    
    const video = document.getElementById('camera');
    const canvas = document.getElementById('snapshot');
    const soilLabel = document.getElementById('soil-output');
    const cropContainer = document.getElementById('crop-output');

    const cropRules = {
        laterite: ["Cashew", "Coffee", "Tea"],
        red: ["Cotton", "Wheat", "Maize"],
        alluvial: ["Rice", "Wheat", "Jute"],
        black: ["Cotton", "Soybean", "Tobacco"],
        arid: ["Bajra", "Millets"],
        mountain: ["Apple", "Barley"]
    };

    async function init() {
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } });
            video.srcObject = stream;
            setInterval(analyzeFrame, 800); 
        } catch(e) { alert("Camera failed: " + e); }
    }

    async function analyzeFrame() {
        const ctx = canvas.getContext('2d');
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        const base64Image = canvas.toDataURL('image/jpeg', 0.4).split(',')[1];

        try {
            const response = await fetch(WORKFLOW_URL, {
                method: "POST",
                headers: { "Content-Type": "application/json" },
                body: JSON.stringify({
                    api_key: API_KEY,
                    inputs: { image: { type: "base64", value: base64Image } }
                })
            });

            const data = await response.json();
            console.log("Roboflow Data:", data);

            // AUTO-DETECTION LOGIC:
            // This searches the entire response for a "class" name
            let detectedClass = null;
            
            // Check standard workflow output first
            if (data.outputs && data.outputs[0] && data.outputs[0].predictions) {
                detectedClass = data.outputs[0].predictions[0].class;
            } 
            // Check for direct output blocks
            else if (data.outputs) {
                for (let key in data.outputs[0]) {
                    if (data.outputs[0][key].class) {
                        detectedClass = data.outputs[0][key].class;
                        break;
                    }
                }
            }

            if (detectedClass) {
                updateUI(detectedClass.toLowerCase());
            }
        } catch (err) { console.warn("Syncing..."); }
    }

    function updateUI(soil) {
        soilLabel.innerText = soil;
        const crops = cropRules[soil] || ["Scanning..."];
        cropContainer.innerHTML = crops.map(c => `<span class="crop-badge">${c}</span>`).join('');
    }

    init();
</script>
</body>
</html>
