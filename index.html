<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgroAI | Live Roboflow Sync</title>

<style>
:root { --primary:#00ff88; --bg:#0b0f14; --glass:rgba(22,27,34,.9); }
body{margin:0;font-family:system-ui;background:var(--bg);color:#fff;overflow:hidden}
.viewport{width:100vw;height:100vh;background:#000;position:relative}
video{width:100%;height:100%;object-fit:cover}
.hud{position:absolute;bottom:30px;left:50%;transform:translateX(-50%);width:90%;max-width:420px}
.glass-panel{
background:var(--glass);
backdrop-filter:blur(25px);
padding:25px;
border-radius:30px;
border:1px solid rgba(255,255,255,.1);
box-shadow:0 20px 50px rgba(0,0,0,.8);
text-align:center}
.status-dot{width:8px;height:8px;background:var(--primary);border-radius:50%;display:inline-block;margin-right:8px;animation:pulse 1s infinite}
@keyframes pulse{50%{opacity:.3}}
#soil-output{font-size:2.1rem;font-weight:900;margin:10px 0;color:var(--primary);text-transform:uppercase}
.crop-container{display:flex;flex-wrap:wrap;justify-content:center;gap:8px}
.crop-badge{border:1px solid var(--primary);color:var(--primary);padding:6px 14px;border-radius:12px;font-size:.8rem;font-weight:700}
.lock-btn{
margin-top:12px;
padding:10px 18px;
border-radius:20px;
border:none;
font-weight:800;
cursor:pointer;
background:var(--primary);
color:#000}
.locked{background:#ff5555;color:white}
canvas{display:none}
</style>
</head>

<body>

<div class="viewport">
<video id="camera" autoplay playsinline></video>

<div class="hud">
<div class="glass-panel">
<div style="font-size:.7rem;letter-spacing:2px;color:#8b949e">
<span class="status-dot"></span> LIVE AI ANALYSIS
</div>

<h1 id="soil-output">Scanning...</h1>
<div id="crop-output" class="crop-container"></div>

<button id="lockBtn" class="lock-btn">LOCK SOIL</button>
</div>
</div>
</div>

<canvas id="snapshot" width="416" height="416"></canvas>

<script>
/* ================= CONFIG ================= */
const API_KEY = "CxxhkxfjWLeZydDtSjFd";
const WORKFLOW_URL = "https://serverless.roboflow.com/amithesh-yppof/workflows/custom-workflow";

/* ================= ELEMENTS ================= */
const video = document.getElementById("camera");
const canvas = document.getElementById("snapshot");
const soilLabel = document.getElementById("soil-output");
const cropContainer = document.getElementById("crop-output");
const lockBtn = document.getElementById("lockBtn");

/* ================= STATE ================= */
let locked = false;
let lockedSoil = null;
let lastSoil = null;

/* ================= CROPS ================= */
const cropRules = {
laterite:["Cashew","Coffee","Tea","Rubber"],
red:["Cotton","Maize","Groundnut","Millets"],
alluvial:["Rice","Wheat","Sugarcane","Jute"],
black:["Cotton","Soybean","Sunflower","Tobacco"],
arid:["Bajra","Millets","Dates"],
mountain:["Apple","Barley","Potato"]
};

/* ================= CAMERA ================= */
async function init(){
const stream = await navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}});
video.srcObject = stream;
setInterval(analyzeFrame,900);
}
init();

/* ================= AI ================= */
async function analyzeFrame(){
if(locked) return;

const ctx = canvas.getContext("2d");
ctx.drawImage(video,0,0,416,416);
const img = canvas.toDataURL("image/jpeg",0.45).split(",")[1];

try{
const res = await fetch(WORKFLOW_URL,{
method:"POST",
headers:{"Content-Type":"application/json"},
body:JSON.stringify({
api_key:API_KEY,
inputs:{image:{type:"base64",value:img}}
})
});

const data = await res.json();
const soil = extractSoil(data);
if(soil && soil!==lastSoil){
lastSoil = soil;
updateUI(soil);
}
}catch{}
}

/* ================= PARSER ================= */
function extractSoil(data){
try{
const out = data.outputs?.[0];
for(const key in out){
if(out[key]?.predictions?.length){
return out[key].predictions[0].class.toLowerCase();
}
}
}catch{}
return null;
}

/* ================= UI ================= */
function updateUI(soil){
soilLabel.innerText = soil;
const crops = cropRules[soil] || ["Analyzingâ€¦"];
cropContainer.innerHTML = crops.map(c=>`<span class="crop-badge">${c}</span>`).join("");
}

/* ================= LOCK ================= */
lockBtn.onclick = ()=>{
locked = !locked;
lockBtn.classList.toggle("locked",locked);
lockBtn.innerText = locked ? "UNLOCK SOIL" : "LOCK SOIL";
if(locked) lockedSoil = lastSoil;
};
</script>

</body>
</html>
