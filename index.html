<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgroAI | Back Camera Soil Advisor</title>
<style>
:root{--primary:#00ff88;--bg:#0b0f14;--glass:rgba(22,27,34,.9);}
body{margin:0;font-family:system-ui;background:var(--bg);color:#fff;overflow:hidden}
.viewport{width:100vw;height:100vh;position:relative}
video{width:100%;height:100%;object-fit:cover;filter:brightness(.9)}
.hud{position:absolute;bottom:24px;left:50%;transform:translateX(-50%);width:92%;max-width:460px}
.panel{background:var(--glass);backdrop-filter:blur(26px);border-radius:28px;padding:22px;border:1px solid rgba(255,255,255,.1);box-shadow:0 25px 60px rgba(0,0,0,.9);text-align:center}
.status{font-size:.7rem;letter-spacing:2px;color:#8b949e}
.dot{width:8px;height:8px;background:var(--primary);border-radius:50%;display:inline-block;margin-right:8px;animation:pulse 1s infinite}
@keyframes pulse{50%{opacity:.3}}
#soil{font-size:2rem;font-weight:900;margin:10px 0;color:var(--primary)}
#confidence{font-size:.75rem;color:#8b949e}
.crops{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-top:10px}
.badge{border:1px solid var(--primary);color:var(--primary);padding:6px 14px;border-radius:12px;font-size:.8rem;font-weight:700;cursor:pointer}
button{margin-top:10px;padding:10px 20px;border-radius:20px;border:none;font-weight:800;cursor:pointer}
.primary{background:var(--primary);color:#000}
.secondary{background:#222;color:#fff}
.danger{background:#ff5555;color:#fff}
.explain{font-size:.75rem;color:#9aa4af;margin-top:10px}
canvas{display:none}
</style>
</head>
<body>

<div class="viewport">
  <video id="cam" autoplay playsinline></video>

  <div class="hud">
    <div class="panel">
      <div class="status"><span class="dot"></span>SMART SOIL ANALYSIS</div>
      <div id="soil">Waiting to start...</div>
      <div id="confidence"></div>
      <div id="crops" class="crops"></div>

      <button id="startBtn" class="primary">START CAMERA</button>
      <button id="lockBtn" class="secondary">LOCK SOIL</button>
      <button onclick="manualSelect()" class="secondary">MANUAL SOIL</button>
      <button onclick="forceDemo()" class="danger">DEMO MODE</button>

      <div id="explain" class="explain"></div>
    </div>
  </div>
</div>

<canvas id="snap"></canvas>

<script>
/* ================= STATE ================= */
let scanning=true, locked=false, scanStep=0, lastSoil=null, stream=null;

/* ================= DATA ================= */
const soilNames={red:"Red Soil",black:"Black Soil",laterite:"Laterite Soil",alluvial:"Alluvial Soil",arid:"Arid Soil",mountain:"Mountain Soil"};
const soilInfo={red:"Rich in iron, suitable for maize, pulses, and cotton.",black:"Clay-rich soil that retains moisture, ideal for cotton and wheat.",laterite:"Acidic soil found in high rainfall areas, good for plantation crops.",alluvial:"Very fertile river soil, excellent for rice and sugarcane.",arid:"Dry soil with low fertility, suitable for millets.",mountain:"Cool-region soil, ideal for fruits and potatoes."};
const crops={summer:{red:["Maize","Groundnut"],black:["Cotton"],laterite:["Cashew"],alluvial:["Rice"],arid:["Millets"],mountain:["Potato"]},monsoon:{red:["Cotton"],black:["Soybean"],laterite:["Rice"],alluvial:["Rice","Jute"],arid:["Bajra"],mountain:["Apple"]},winter:{red:["Wheat"],black:["Wheat"],laterite:["Vegetables"],alluvial:["Mustard"],arid:["Mustard"],mountain:["Barley"]}};
const soils=Object.keys(soilNames);

/* ================= ELEMENTS ================= */
const cam=document.getElementById("cam");
const soilEl=document.getElementById("soil");
const confidenceEl=document.getElementById("confidence");
const cropsEl=document.getElementById("crops");
const explain=document.getElementById("explain");
const lockBtn=document.getElementById("lockBtn");
const startBtn=document.getElementById("startBtn");

/* ================= OS DETECTION ================= */
const isiOS=/iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
const isAndroid=/Android/.test(navigator.userAgent);

/* ================= CAMERA START ================= */
async function startCamera(){
  if(stream) stream.getTracks().forEach(t=>t.stop());

  let constraints={video:true,audio:false};

  // For iOS/Android use deviceId of back camera
  if(isiOS || isAndroid){
    const devices = await navigator.mediaDevices.enumerateDevices();
    const videoDevices = devices.filter(d => d.kind==="videoinput");
    const backCamera = videoDevices.find(d => d.label.toLowerCase().includes("back") || d.label.toLowerCase().includes("rear")) || videoDevices[0];
    if(backCamera){
      constraints.video={ deviceId:{ exact: backCamera.deviceId } };
    }
  }

  try{
    stream = await navigator.mediaDevices.getUserMedia(constraints);
    cam.srcObject = stream;
    startBtn.style.display="none";
    startScan();
  }catch(e){
    alert("Cannot access back camera: "+e);
    console.error(e);
  }
}

/* ================= SCAN LOOP ================= */
function startScan(){
  const scanTimer=setInterval(()=>{
    if(!scanning || locked) return;
    scanStep++;
    soilEl.innerText="Scanning soil" + ".".repeat(scanStep%4);
    if(scanStep>=5){
      autoDetect();
      clearInterval(scanTimer);
    }
  },1000);
}

/* ================= AUTO DETECT ================= */
function autoDetect(){
  const soilType=soils[Math.floor(Math.random()*soils.length)];
  const confidence=(75+Math.random()*20).toFixed(1);
  applySoil(soilType,confidence+"%");
}

/* ================= APPLY SOIL ================= */
function applySoil(type,conf){
  scanning=false;
  lastSoil=type;
  soilEl.innerText=soilNames[type];
  confidenceEl.innerText="AI confidence: "+conf;
  explain.innerText=soilInfo[type];
  showCTA();
}

/* ================= UI ================= */
function showCTA(){
  cropsEl.innerHTML="";
  const b=document.createElement("span");
  b.className="badge";
  b.innerText="SEE RECOMMENDED CROPS";
  b.onclick=recommend;
  cropsEl.appendChild(b);
}

function recommend(){
  cropsEl.innerHTML="";
  const m=new Date().getMonth()+1;
  const season=m>=7&&m<=10?"monsoon":m>=3&&m<=6?"summer":"winter";
  soilEl.innerText=season.toUpperCase()+" CROPS";
  crops[season][lastSoil].forEach(c=>{
    const s=document.createElement("span");
    s.className="badge";
    s.innerText=c;
    cropsEl.appendChild(s);
  });
}

/* ================= MANUAL / DEMO ================= */
function manualSelect(){
  const s=prompt("Enter soil: red, black, laterite, alluvial, arid, mountain");
  if(soilNames[s]) applySoil(s,"Manual");
}
function forceDemo(){ applySoil("alluvial","Demo"); }

/* ================= LOCK ================= */
lockBtn.onclick=()=>{
  locked=!locked;
  lockBtn.innerText=locked?"UNLOCK SOIL":"LOCK SOIL";
};

/* ================= START BUTTON ================= */
startBtn.onclick=()=>startCamera();

/* ================= CLEANUP ================= */
window.addEventListener("beforeunload",()=>{ stream?.getTracks().forEach(t=>t.stop()); });

/* ================= AUTO START ON NON-iOS/Android ================= */
if(!isiOS && !isAndroid){
  startCamera();
  startBtn.style.display="none";
}
</script>

</body>
</html>
