<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AI Farmer Assistant</title>

<style>
body { margin:0; background:black; font-family:system-ui; overflow:hidden; }
video { width:100vw; height:100vh; object-fit:cover; }
#box {
  position:fixed; bottom:20px; left:50%; transform:translateX(-50%);
  background:rgba(0,0,0,0.7); color:white;
  padding:14px 20px; border-radius:16px;
  max-width:90%; text-align:center;
}
</style>
</head>

<body>

<video id="video" autoplay playsinline></video>
<canvas id="canvas" width="640" height="640" style="display:none"></canvas>
<div id="box">Initializing AIâ€¦</div>

<script>
const ROBOFLOW_URL = "https://serverless.roboflow.com/amithesh-yppof/workflows/custom-workflow";
const ROBOFLOW_KEY = "CxxhkxfjWLeZydDtSjFd";

const OPENAI_KEY = "OPENAI_API_KEY_HERE"; // ðŸ”´ REQUIRED

const video = document.getElementById("video");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");
const box = document.getElementById("box");

let locked = false;

async function init() {
  const stream = await navigator.mediaDevices.getUserMedia({
    video:{ facingMode:"environment" }, audio:false
  });
  video.srcObject = stream;
  video.onloadedmetadata = () => {
    video.play();
    setInterval(detectSoil, 500);
  };
}

async function detectSoil() {
  if (locked) return;

  ctx.drawImage(video,0,0,640,640);
  const img = canvas.toDataURL("image/jpeg",0.7).split(",")[1];

  const res = await fetch(ROBOFLOW_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body:JSON.stringify({
      api_key: ROBOFLOW_KEY,
      inputs:{ image:{ type:"base64", value: img } }
    })
  });

  const data = await res.json();
  if (!data.outputs?.[0]?.predictions?.length) return;

  const soil = data.outputs[0].predictions[0].class;
  locked = true;

  const now = new Date();
  const date = now.toLocaleDateString();
  const time = now.toLocaleTimeString();

  box.innerText = `Soil detected: ${soil}\nConsulting AIâ€¦`;

  askChatGPT(soil, date, time);
}

async function askChatGPT(soil, date, time) {
  const prompt = `
Soil type: ${soil}
Date: ${date}
Time: ${time}
Region: Tropical (India)

What is the best crop to grow now?
Give a short answer for a farmer.
`;

  const res = await fetch("https://api.openai.com/v1/chat/completions", {
    method:"POST",
    headers:{
      "Content-Type":"application/json",
      "Authorization":"Bearer " + OPENAI_KEY
    },
    body:JSON.stringify({
      model:"gpt-4.1-mini",
      messages:[{role:"user",content:prompt}],
      max_tokens:100
    })
  });

  const data = await res.json();
  const answer = data.choices[0].message.content;

  box.innerText =
    `Soil: ${soil}\nDate: ${date}\nTime: ${time}\n\nðŸŒ± Best crop:\n${answer}`;
}

init();
</script>
</body>
</html>
