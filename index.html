<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>AgroAI | Smart Crop Advisor</title>

<style>
:root{
  --primary:#00ff88;
  --bg:#0b0f14;
  --glass:rgba(22,27,34,.88);
}
*{box-sizing:border-box}
body{
  margin:0;
  font-family:system-ui,-apple-system,Segoe UI;
  background:var(--bg);
  color:#fff;
  overflow:hidden;
}
.viewport{width:100vw;height:100vh;position:relative}
video{width:100%;height:100%;object-fit:cover}
.hud{
  position:absolute;
  bottom:25px;
  left:50%;
  transform:translateX(-50%);
  width:92%;
  max-width:420px;
}
.glass{
  background:var(--glass);
  backdrop-filter:blur(22px);
  border-radius:28px;
  padding:22px;
  border:1px solid rgba(255,255,255,.1);
  box-shadow:0 25px 60px rgba(0,0,0,.8);
  text-align:center;
}
.status{
  font-size:.7rem;
  letter-spacing:2px;
  color:#8b949e;
}
.dot{
  display:inline-block;
  width:8px;height:8px;
  background:var(--primary);
  border-radius:50%;
  margin-right:8px;
  animation:pulse 1s infinite;
}
@keyframes pulse{50%{opacity:.3}}
#soil{
  font-size:2rem;
  font-weight:900;
  margin:12px 0;
  color:var(--primary);
}
.crops{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:8px;
}
.badge{
  padding:6px 14px;
  border-radius:12px;
  border:1px solid var(--primary);
  color:var(--primary);
  font-size:.8rem;
  font-weight:700;
}
button{
  margin-top:12px;
  padding:10px 20px;
  border-radius:20px;
  border:none;
  font-weight:800;
  cursor:pointer;
}
.lock{background:var(--primary);color:#000}
.locked{background:#ff5555;color:#fff}
canvas{display:none}
</style>
</head>

<body>
<div class="viewport">
  <video id="cam" autoplay playsinline></video>

  <div class="hud">
    <div class="glass">
      <div class="status"><span class="dot"></span>LIVE AI ANALYSIS</div>
      <div id="soil">Scanning…</div>
      <div id="crops" class="crops"></div>
      <button id="lockBtn" class="lock">LOCK SOIL</button>
    </div>
  </div>
</div>

<canvas id="snap" width="416" height="416"></canvas>

<script>
/* ================= CONFIG ================= */
// ⚠️ SCHOOL DEMO ONLY – rotate keys after submission
const RF_KEY="CxxhkxfjWLeZydDtSjFd";
const WORKFLOW="https://serverless.roboflow.com/amithesh-yppof/workflows/custom-workflow";

/* ================= STATE ================= */
let locked=false,lastSoil=null,stream=null;

/* ================= SOILS ================= */
const soilMap={
  laterite:"Laterite Soil",
  red:"Red Soil",
  black:"Black Soil",
  alluvial:"Alluvial Soil",
  arid:"Arid Soil",
  mountain:"Mountain Soil"
};

/* ================= CROPS (India-based seasons) ================= */
const crops={
summer:{laterite:["Cashew","Coffee"],red:["Maize","Groundnut"],black:["Cotton"],alluvial:["Rice"],arid:["Millets"],mountain:["Potato"]},
monsoon:{laterite:["Rice","Tea"],red:["Cotton"],black:["Soybean"],alluvial:["Rice","Jute"],arid:["Bajra"],mountain:["Apple"]},
winter:{laterite:["Vegetables"],red:["Wheat"],black:["Wheat"],alluvial:["Mustard"],arid:["Mustard"],mountain:["Barley"]}
};

/* ================= ELEMENTS ================= */
const cam=document.getElementById("cam");
const snap=document.getElementById("snap");
const soilEl=document.getElementById("soil");
const cropEl=document.getElementById("crops");
const lockBtn=document.getElementById("lockBtn");

/* ================= CAMERA ================= */
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>{
  stream=s;
  cam.srcObject=s;
  setInterval(scan,1200);
});

/* ================= SCAN ================= */
async function scan(){
  if(locked||document.hidden) return;

  const ctx=snap.getContext("2d");
  ctx.drawImage(cam,0,0,416,416);
  const img=snap.toDataURL("image/jpeg",0.45).split(",")[1];

  try{
    const r=await fetch(WORKFLOW,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        api_key:RF_KEY,
        inputs:{image:{type:"base64",value:img}}
      })
    });
    const d=await r.json();
    const soil=extractSoil(d);
    if(soil){
      lastSoil=soil;
      soilEl.innerText=soilMap[soil]||soil;
      showCTA();
    }
  }catch{}
}

function extractSoil(d){
  const o=d?.outputs?.[0];
  if(!o) return null;
  for(const k of Object.keys(o)){
    const p=o[k]?.predictions;
    if(Array.isArray(p)&&p.length){
      return p[0].class.toLowerCase();
    }
  }
  return null;
}

/* ================= UI ================= */
function showCTA(){
  cropEl.innerHTML="";
  const b=document.createElement("span");
  b.className="badge";
  b.innerText="SEE RECOMMENDED CROPS";
  b.onclick=recommend;
  cropEl.appendChild(b);
}

/* ================= RECOMMEND ================= */
function recommend(){
  cropEl.innerHTML="";
  soilEl.innerText="Analyzing season…";

  setTimeout(()=>{
    const m=new Date().getMonth()+1;
    const season=m>=7&&m<=10?"monsoon":m>=3&&m<=6?"summer":"winter";

    const list=crops[season]?.[lastSoil]||[];
    soilEl.innerText=season.toUpperCase()+" CROPS";

    [...new Set(list)].slice(0,5).forEach(c=>{
      const s=document.createElement("span");
      s.className="badge";
      s.innerText=c;
      cropEl.appendChild(s);
    });
  },1000);
}

/* ================= LOCK ================= */
lockBtn.onclick=()=>{
  locked=!locked;
  lockBtn.className=locked?"locked":"lock";
  lockBtn.innerText=locked?"UNLOCK SOIL":"LOCK SOIL";
};

/* ================= CLEANUP ================= */
window.addEventListener("beforeunload",()=>{
  stream?.getTracks().forEach(t=>t.stop());
});
</script>
</body>
</html>
