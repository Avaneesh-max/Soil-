<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>AgroAI | Smart Crop Advisor</title>

<style>
:root{
  --primary:#00ff88;
  --bg:#0b0f14;
  --glass:rgba(22,27,34,.88);
}
body{
  margin:0;
  font-family:system-ui;
  background:var(--bg);
  color:white;
  overflow:hidden;
}
.viewport{width:100vw;height:100vh;position:relative}
video{width:100%;height:100%;object-fit:cover}
.hud{
  position:absolute;
  bottom:24px;
  left:50%;
  transform:translateX(-50%);
  width:92%;
  max-width:420px;
}
.panel{
  background:var(--glass);
  backdrop-filter:blur(24px);
  border-radius:28px;
  padding:22px;
  border:1px solid rgba(255,255,255,.1);
  box-shadow:0 25px 60px rgba(0,0,0,.85);
  text-align:center;
}
.status{
  font-size:.7rem;
  letter-spacing:2px;
  color:#8b949e;
}
.dot{
  width:8px;height:8px;
  background:var(--primary);
  border-radius:50%;
  display:inline-block;
  margin-right:8px;
  animation:pulse 1s infinite;
}
@keyframes pulse{50%{opacity:.3}}
#soil{
  font-size:2rem;
  font-weight:900;
  margin:12px 0;
  color:var(--primary);
}
.crops{
  display:flex;
  flex-wrap:wrap;
  justify-content:center;
  gap:8px;
}
.badge{
  border:1px solid var(--primary);
  color:var(--primary);
  padding:6px 14px;
  border-radius:12px;
  font-size:.8rem;
  font-weight:700;
  cursor:pointer;
}
button{
  margin-top:12px;
  padding:10px 22px;
  border-radius:20px;
  border:none;
  font-weight:800;
  cursor:pointer;
}
.lock{background:var(--primary);color:#000}
.locked{background:#ff5555;color:#fff}
canvas{display:none}
</style>
</head>

<body>

<div class="viewport">
  <video id="cam" autoplay playsinline></video>

  <div class="hud">
    <div class="panel">
      <div class="status"><span class="dot"></span>LIVE AI ANALYSIS</div>
      <div id="soil">Scanning soil…</div>
      <div id="crops" class="crops"></div>
      <button id="lockBtn" class="lock">LOCK SOIL</button>
    </div>
  </div>
</div>

<canvas id="snap" width="416" height="416"></canvas>

<script>
/* ================= CONFIG ================= */
// ⚠️ DEMO ONLY – rotate keys later
const RF_KEY = "CxxhkxfjWLeZydDtSjFd";
const WORKFLOW = "https://serverless.roboflow.com/amithesh-yppof/workflows/custom-workflow";

/* ================= STATE ================= */
let stream=null;
let scanInterval=null;
let scanCount=0;
let locked=false;
let lastSoil=null;
const MAX_SCANS=10;

/* ================= DATA ================= */
const soilNames={
  laterite:"Laterite Soil",
  red:"Red Soil",
  black:"Black Soil",
  alluvial:"Alluvial Soil",
  arid:"Arid Soil",
  mountain:"Mountain Soil"
};

const crops={
  summer:{laterite:["Cashew","Coffee"],red:["Maize","Groundnut"],black:["Cotton"],alluvial:["Rice"],arid:["Millets"],mountain:["Potato"]},
  monsoon:{laterite:["Rice","Tea"],red:["Cotton"],black:["Soybean"],alluvial:["Rice","Jute"],arid:["Bajra"],mountain:["Apple"]},
  winter:{laterite:["Vegetables"],red:["Wheat"],black:["Wheat"],alluvial:["Mustard"],arid:["Mustard"],mountain:["Barley"]}
};

/* ================= ELEMENTS ================= */
const cam=document.getElementById("cam");
const snap=document.getElementById("snap");
const soilEl=document.getElementById("soil");
const cropEl=document.getElementById("crops");
const lockBtn=document.getElementById("lockBtn");

/* ================= CAMERA ================= */
navigator.mediaDevices.getUserMedia({video:{facingMode:"environment"}})
.then(s=>{
  stream=s;
  cam.srcObject=s;
  scanInterval=setInterval(scan,1200);
});

/* ================= SCAN ================= */
async function scan(){
  if(locked||document.hidden) return;

  scanCount++;

  const ctx=snap.getContext("2d");
  ctx.drawImage(cam,0,0,416,416);
  const img=snap.toDataURL("image/jpeg",0.45).split(",")[1];

  try{
    const r=await fetch(WORKFLOW,{
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body:JSON.stringify({
        api_key:RF_KEY,
        inputs:{image:{type:"base64",value:img}}
      })
    });

    const d=await r.json();
    console.log("RF RESPONSE:",d);

    const soil=normalizeSoil(extractSoil(d));

    if(soil){
      lastSoil=soil;
      soilEl.innerText=soilNames[soil]||soil;
      showCTA();
      stopScan();
      return;
    }

    if(scanCount>=MAX_SCANS){
      soilEl.innerText="No soil detected";
      cropEl.innerHTML="<span class='badge'>Improve lighting / angle</span>";
      stopScan();
    }

  }catch(e){
    console.error(e);
    soilEl.innerText="AI error";
    stopScan();
  }
}

function stopScan(){
  clearInterval(scanInterval);
}

/* ================= AI PARSING ================= */
function extractSoil(d){
  if(d?.outputs?.[0]?.predictions?.length)
    return d.outputs[0].predictions[0].class;

  if(d?.predictions?.length)
    return d.predictions[0].class;

  if(d?.outputs?.[0]){
    for(const k in d.outputs[0]){
      const p=d.outputs[0][k]?.predictions;
      if(Array.isArray(p)&&p.length)
        return p[0].class;
    }
  }
  return null;
}

function normalizeSoil(s){
  if(!s) return null;
  s=s.toLowerCase().replace(/[\s-_]/g,"");
  const map={
    redsoil:"red",red:"red",
    blacksoil:"black",black:"black",
    lateritic:"laterite",laterite:"laterite",
    alluvial:"alluvial",
    arid:"arid",
    mountain:"mountain"
  };
  return map[s]||null;
}

/* ================= UI ================= */
function showCTA(){
  cropEl.innerHTML="";
  const b=document.createElement("span");
  b.className="badge";
  b.innerText="SEE RECOMMENDED CROPS";
  b.onclick=recommend;
  cropEl.appendChild(b);
}

function recommend(){
  cropEl.innerHTML="";
  soilEl.innerText="Analyzing season…";

  setTimeout(()=>{
    const m=new Date().getMonth()+1;
    const season=m>=7&&m<=10?"monsoon":m>=3&&m<=6?"summer":"winter";
    const list=crops[season]?.[lastSoil]||[];

    soilEl.innerText=season.toUpperCase()+" CROPS";
    [...new Set(list)].forEach(c=>{
      const s=document.createElement("span");
      s.className="badge";
      s.innerText=c;
      cropEl.appendChild(s);
    });
  },900);
}

/* ================= LOCK ================= */
lockBtn.onclick=()=>{
  locked=!locked;
  lockBtn.className=locked?"locked":"lock";
  lockBtn.innerText=locked?"UNLOCK SOIL":"LOCK SOIL";
};

/* ================= CLEANUP ================= */
window.addEventListener("beforeunload",()=>{
  stream?.getTracks().forEach(t=>t.stop());
});
</script>
</body>
</html>
